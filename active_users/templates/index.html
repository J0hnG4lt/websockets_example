
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<div class="user_pages">
    <span class="">
        Users
    </span>
    <div class="user_links">
        {% for user in users %}
            {# Each "user" is a User model object. #}
            
            <a  data="{{ user.username }}"
                href="" >
                {{ user.username|upper }}
            </a> 
            {% if user.active %}
            
            <span id="{{ user.username }}">
                This user is active
            </span>
            
            {% else %}
            
            <span id="{{ user.username }}"
                  hidden>
                This user is active
            </span>
            
            {% endif %}
            
            <br />
            
            
        {% endfor %}
    </div>
</div>
<!--
<div class="pagination">
    <span class="step-links">
        {% if users.has_previous %}
            <a href="?page=1">&laquo; first</a>
            <a href="?page={{ users.previous_page_number }}">previous</a>
        {% endif %}

        <span class="current">
            Page {{ users.number }} of {{ users.paginator.num_pages }}.
        </span>

        {% if users.has_next %}
            <a href="?page={{ users.next_page_number }}">next</a>
            <a href="?page={{ users.paginator.num_pages }}">last &raquo;</a>
        {% endif %}
    </span>
</div>
-->
<script>
    
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var active_users_socket = new WebSocket(ws_scheme + '://' 
                + window.location.host 
                + window.location.pathname);
    
    $('.user_links a').on('click', function(event) {
        
        if (window.username !== undefined){
            
            //send a disconect message from the previous user
            var message = {"message" : window.username,
                           "status" : "inactive",
                           "exclude" : 1 }
            
            active_users_socket.send(JSON.stringify(message));
            
            window.username = undefined;
            
            $('.user_links span[id="'+window.username+'"]').attr("hidden", true);
        }
        
        var username = event.target.attributes.data.nodeValue;
        
        var message = {"message" : username,
                       "status" : "active",
                       "include" : 1 }
        
        active_users_socket.send(JSON.stringify(message));
        
        console.log(event.target.attributes)
        
        window.username = username;
        
        
        return false;

    });

    active_users_socket.onmessage = function(event2) {
        
        var data = JSON.parse(event2.data);
        console.log(data["message"]);
        
        var new_active_user = data["message"];
        var status = data["status"];
        console.log(status);
        if (status === "active"){
            $('.user_links span[id="'+new_active_user+'"]').attr("hidden", false);     }
        else if (status === "inactive") {
            $('.user_links span[id="'+new_active_user+'"]').attr("hidden", true);
        }
        
    };
    
</script>
